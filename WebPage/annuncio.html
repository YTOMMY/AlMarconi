<!DOCTYPE html>
<html lang="it">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Annuncio - AlMarconi</title>
	<link rel="stylesheet" href="style.css">
</head>
<body>

	<div class="top-bar">
		<div class="left">
			<a href="index.html"><img src="logo.jpeg" alt="Logo" class="logo"></a>
		</div>

		<div class="center">
			<h1>Annuncio</h1>
		</div>

		<div class="right">
			<div id="account"></div>
		</div>
	</div>

	<div class="container">
		<div id="pagina"></div>
	</div>

	<script>
		const userId = sessionStorage.getItem("userId");
		const verificato = sessionStorage.getItem("verificato");
		const tipo = sessionStorage.getItem("tipo");

		if (!userId || userId == 0) {
			document.getElementById("account").innerHTML = `
				<a href="login.html" class="menu">Accedi</a>
			`;

			document.getElementById("pagina").innerHTML = `
				<h3>Benvenuto in AlMarconi</h3>
				<p>Accedi per visualizzare le informazioni</p>
			`;
		} else {
			document.getElementById("account").innerHTML = `
				<a href="impostazioni.html" class="menu">Impostazioni</a>
			`;

			if (verificato != 1) {
				document.getElementById("pagina").innerHTML = `
					<p>Account in attesa di validazione</p>
				`;
			} else {
				if (tipo === "studente" || tipo === "azienda") {
					const params = new URLSearchParams(window.location.search);
					const idAnnuncio = params.get("id");

					if (!idAnnuncio) {
						document.getElementById("pagina").innerHTML = "Errore: Annuncio non trovato";
					} else {
						window.addEventListener('DOMContentLoaded', async function () {
							try {
								const response = await fetch(`api.php/annuncio/${idAnnuncio}`, {
									method: 'GET'
								});

								const responseData = await response.json();

								if (response.ok) {
									const contratto = responseData.tipoContratto;
									const mansione = responseData.mansione;
									const descrizione = responseData.descrizione;
									const areaDisciplinare = responseData.areaDisciplinare;
									const abilitaRichieste = responseData.abilitaRichieste;
									const dataPubblicazione = responseData.dataPubblicazione;
									const dataScadenza = responseData.dataScadenza;
									const maxIscrizioni = responseData.maxIscrizioni;
									const postiDisponibili = maxIscrizioni - responseData.attualiIscrizioni;
									const idAzienda = responseData.azienda.id;
									const nomeAzienda = responseData.azienda.nomeAzienda;
									const citta = responseData.sede.Citta;
									const via = responseData.sede.via;
									const civico = responseData.sede.civico;

									const pagina = document.getElementById("pagina");
									pagina.innerHTML = `
										<h3><a href="azienda.html?id=${idAzienda}">${nomeAzienda}</a></h3>
										<p>Mansione: ${mansione}</p>
										<p>Città: ${citta}</p>
										<p>Indirizzo: ${via}, ${civico}</p>
										<p>Tipologia di contratto: ${contratto}</p>
										<p>Area disciplinare: ${areaDisciplinare}</p>
										<p><strong>Descrizione</strong><br>${descrizione}</p>
										<p><strong>Abilità richieste</strong><br>${abilitaRichieste}</p>
										<p>Data Pubblicazione: ${dataPubblicazione}</p>
										<p>Data Scadenza: ${dataScadenza}</p>
										<p>Numero massimo posti: ${maxIscrizioni}</p>
										<p>Posti disponibili: ${postiDisponibili}</p>
									`;

									if (tipo === "studente") {
										pagina.innerHTML += `
											<br><button id="candidamiBtn">Candidami</button>
											<br><button id="annullaCandidaturaBtn">Annulla candidatura</button>
										`;

										document.getElementById("candidamiBtn").addEventListener("click", async function () {
											const responseCand = await fetch(`api.php/annuncio/${idAnnuncio}/candidati`, {
												method: 'POST'
											});

											if (responseCand.ok) {
												location.reload();
											} else {
												alert("Errore durante la candidatura.");
											}
										});

										document.getElementById("annullaCandidaturaBtn").addEventListener("click", async function () {
											const responseCanc = await fetch(`api.php/annuncio/${idAnnuncio}/candidati/${userId}`, {
												method: 'DELETE'
											});

											if (responseCanc.ok) {
												location.reload();
											} else {
												alert("Errore durante la rimozione della candidatura.");
											}
										});
									}

									if (tipo === "azienda" && userId == idAzienda) {
										pagina.innerHTML += `
											<br><button id="listaCandidatiBtn">Mostra la lista dei candidati</button>
										`;

										document.getElementById("listaCandidatiBtn").addEventListener("click", async function () {
											const responseList = await fetch(`api.php/annuncio/${idAnnuncio}/candidati`, {
												method: 'GET'
											});

											if (responseList.ok) {
												const candidati = await responseList.json();

												if (candidati.length === 0) {
													pagina.innerHTML += `<p>Al momento non sono presenti candidature</p>`;
												} else {
													for (const studente of candidati) {
														pagina.innerHTML += `<br><a href="schedaStudente.html?id=${studente.id}">${studente.nome} ${studente.cognome}</a>`;
													}
												}
											} else {
												pagina.innerHTML += `<p>Non è stato possibile recuperare i dati.</p>`;
											}
										});
									}
								}
							} catch (error) {
								document.getElementById("pagina").textContent = 'Errore nella comunicazione con il server.';
							}
						});
					}
				} else {
					document.getElementById("pagina").innerHTML = `
						Errore: non è stato possibile recuperare i dati
					`;
				}
			}
		}
	</script>

</body>
</html>
